defaults: &defaults
  working_directory: ~/digital-hub
  docker:
    - image: mojdigitalstudio/circleci-build-container

version: 2
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build node frontend container
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
                cd moj-node && \
                BUILD_NUMBER="$CIRCLE_BUILD_NUM" \
                GIT_REF="$CIRCLE_SHA1" \
                GIT_DATE="$(git log --format=%cd -n1 --date=iso $CIRCLE_SHA1)" \
                make build
            else
                cd moj-node && make build
            fi
      - save_cache:
          key: dependency-cache-{{ checksum "moj-node/package-lock.json" }}
          paths:
            - node_modules
      - run:
          name: push moj-node to docker
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
                cd moj-node && make push
            fi
      - run:
          name: tag build
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
                git config user.name "Circle CI"
                git config user.email "circle@circleci.com"
                git tag -a "$(date '+%d-%m-%Y')-$CIRCLE_BUILD_NUM" $CIRCLE_SHA1 -m "$(git log -1 --pretty=%B)"
                git push origin "$(date '+%d-%m-%Y')-$CIRCLE_BUILD_NUM"
            fi
  build_cms:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build backend container
          command: cd moj-be && make build
      - run:
          name: push be to docker
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
                cd moj-be && make push
            fi

  run_e2e_test:
    docker:
      - image: circleci/node:10.15.3-browsers
    working_directory: /home/circleci/app
    steps:
      - checkout
      - run:
          name: Update npm
          command: "sudo npm install -g npm@latest"
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: Install Dependencies
          command: cd moj-node && npm ci
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - run:
          name: E2E test
          command: |
            cd moj-node && \
            npm run build && \
            BUILD_NUMBER="$CIRCLE_BUILD_NUM" \
            GIT_REF="$CIRCLE_SHA1" \
            GIT_DATE="$(git log --format=%cd -n1 --date=iso $CIRCLE_SHA1)" \
            npm run record-build-info && \
            APP_NAME="HMP Local" \
            NODE_ENV=production \
            MATOMO_URL="foo.bar" \
            MATOMO_TOKEN="foobar" \
            MATOMO_API_URI="http://hub-matomo" \
            ENABLE_PRISON_SWITCH="true" \
            HUB_API_ENDPOINT="https://drupal.digital-hub-stage.hmpps.dsd.io" \
            DRUPAL_APP_URI="https://drupal.digital-hub-stage.hmpps.dsd.io" \
            ELASTICSEARCH_ENDPOINT="UNSET"
            npm run test:e2e:run
      - store_test_results:
          path: ./reports
      - store_artifacts:
          path: ./reports

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build
      - run_e2e_test:
          requires:
            - build
      - build_cms:
          requires:
            - build
